name: Destroy Test Environment

on:
  workflow_dispatch:

jobs:
  destroy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Environment Variables per Test Config
        id: vars
        run: |
          echo "COMPOSE_PROJECT_NAME=10xcoder-test" >> $GITHUB_OUTPUT
          echo "APP_CONTAINER_NAME=10xcoder_test_app" >> $GITHUB_OUTPUT
          echo "DB_CONTAINER_NAME=10xcoder_test_db" >> $GITHUB_OUTPUT
          echo "REDIS_CONTAINER_NAME=10xcoder_test_redis" >> $GITHUB_OUTPUT
          echo "NGINX_CONTAINER_NAME=10xcoder_test_nginx" >> $GITHUB_OUTPUT
          echo "DB_VOLUME_NAME=postgres_test_data" >> $GITHUB_OUTPUT
          echo "REDIS_VOLUME_NAME=redis_test_data" >> $GITHUB_OUTPUT
          echo "NGINX_PORT=8080" >> $GITHUB_OUTPUT

      - name: Destroy Test Environment on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: 22
          script: |
            # Try to cd into project directory
            if ! cd /home/${{ secrets.USERNAME }}/${{ steps.vars.outputs.COMPOSE_PROJECT_NAME }} 2>/dev/null; then
              echo "⚠️  Project directory not found, attempting to stop containers by name..."
              
              # Stop containers by name (they might still be running)
              docker stop ${{ steps.vars.outputs.APP_CONTAINER_NAME }} ${{ steps.vars.outputs.DB_CONTAINER_NAME }} ${{ steps.vars.outputs.REDIS_CONTAINER_NAME }} ${{ steps.vars.outputs.NGINX_CONTAINER_NAME }} 2>/dev/null || true
              
              # Remove containers by name
              docker rm ${{ steps.vars.outputs.APP_CONTAINER_NAME }} ${{ steps.vars.outputs.DB_CONTAINER_NAME }} ${{ steps.vars.outputs.REDIS_CONTAINER_NAME }} ${{ steps.vars.outputs.NGINX_CONTAINER_NAME }} 2>/dev/null || true
              
              # Also try to find and remove any containers with the project label
              docker ps -a --filter "label=com.docker.compose.project=${{ steps.vars.outputs.COMPOSE_PROJECT_NAME }}" -q | xargs -r docker rm -f 2>/dev/null || true
              
              echo "✅ Container cleanup attempted (directory was missing)"
              exit 0
            fi

            # Export variables to match what was used in up
            export APP_CONTAINER_NAME=${{ steps.vars.outputs.APP_CONTAINER_NAME }}
            export DB_CONTAINER_NAME=${{ steps.vars.outputs.DB_CONTAINER_NAME }}
            export REDIS_CONTAINER_NAME=${{ steps.vars.outputs.REDIS_CONTAINER_NAME }}
            export NGINX_CONTAINER_NAME=${{ steps.vars.outputs.NGINX_CONTAINER_NAME }}
            export DB_VOLUME_NAME=${{ steps.vars.outputs.DB_VOLUME_NAME }}
            export REDIS_VOLUME_NAME=${{ steps.vars.outputs.REDIS_VOLUME_NAME }}
            export NGINX_PORT=${{ steps.vars.outputs.NGINX_PORT }}
            export COMPOSE_PROJECT_NAME=${{ steps.vars.outputs.COMPOSE_PROJECT_NAME }}

            # Bring down containers but keep volumes
            if ! docker compose down --remove-orphans; then
              echo "❌ Failed to bring down containers"
              exit 1
            fi
            echo "✅ Containers stopped successfully"

            # Cleanup directory
            cd ..
            if rm -rf ${{ steps.vars.outputs.COMPOSE_PROJECT_NAME }}; then
              echo "✅ Directory cleaned up successfully"
            else
              echo "❌ Failed to remove directory"
              exit 1
            fi

            echo "✅ Test environment destroyed successfully"
