name: Deploy Production

on:
  workflow_run:
    workflows: ['Build and Push to GHCR']
    types: [completed]
    branches: ['main']

concurrency:
  group: deploy-production
  cancel-in-progress: true

env:
  COMPOSE_PROJECT_NAME: 10xcoder-prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # ----------------------------------------------------------------------
      # Checkout
      # ----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------------------------------------------------
      # Create ENV file
      # ----------------------------------------------------------------------
      - name: Create production env file
        run: |
          echo "${{ secrets.ENV_FILE_PROD }}" > .env

      # ----------------------------------------------------------------------
      # Copy config files to EC2
      # ----------------------------------------------------------------------
      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: 22
          source: >
            docker-compose.yml,
            nginx,
            .env,
            scripts
          target: /home/${{ secrets.USERNAME }}/10xcoder-prod

      # ----------------------------------------------------------------------
      # Deploy on EC2 (pull and restart)
      # ----------------------------------------------------------------------
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: 22
          command_timeout: 5m
          script: |
            set -e

            cd /home/${{ secrets.USERNAME }}/10xcoder-prod

            echo "ğŸ” Loading environment"
            set -a
            source .env
            set +a

            export COMPOSE_PROJECT_NAME=10xcoder-prod

            echo "ğŸ”‘ Login to GHCR"
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin

            echo "ğŸ“¥ Pulling latest images"
            docker compose pull

            echo "ğŸš€ Starting containers"
            docker compose up -d

            echo "â³ Waiting for DB to be ready"
            for i in {1..30}; do
              if docker compose exec -T db pg_isready -U "$POSTGRES_USER" >/dev/null 2>&1; then
                echo "âœ… DB ready"
                break
              fi
              sleep 2
            done

            echo "ğŸ§ª Running migrations"
            docker compose --profile migrate run --rm migrate || true

            echo "ğŸ—‘ï¸ Cleaning old images"
            docker image prune -f || true

            echo "ğŸ“Š Final container status"
            docker compose ps

            echo "ğŸ‰ Deployment completed successfully"
