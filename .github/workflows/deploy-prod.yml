name: Deploy Production

on:
  push:
    branches: ['main']

concurrency:
  group: deploy-production
  cancel-in-progress: true

env:
  COMPOSE_PROJECT_NAME: 10xcoder-prod
  APP_CONTAINER_NAME: 10xcoder_prod_app
  DB_CONTAINER_NAME: 10xcoder_prod_db
  REDIS_CONTAINER_NAME: 10xcoder_prod_redis
  NGINX_CONTAINER_NAME: 10xcoder_prod_nginx
  DB_VOLUME_NAME: postgres_prod_data
  REDIS_VOLUME_NAME: redis_prod_data
  NGINX_PORT: 80
  APP_PORT: 3000

# ============================================================================
# JOB 1 ‚Äî DEPLOY
# ============================================================================
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create production env file
        run: |
          echo "${{ secrets.ENV_FILE_PROD }}" > .env.production

      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: 22
          source: >
            docker-compose.yml,
            nginx,
            apps/api,
            apps/web/package.json,
            packages,
            package.json,
            bun.lock,
            tsconfig.base.json,
            .env.production,
            scripts
          target: /home/${{ secrets.USERNAME }}/${{ env.COMPOSE_PROJECT_NAME }}

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: 22
          command_timeout: 15m
          script: |
            set -e

            cd /home/${{ secrets.USERNAME }}/${{ env.COMPOSE_PROJECT_NAME }}

            mv .env.production .env

            export COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }}
            export APP_CONTAINER_NAME=${{ env.APP_CONTAINER_NAME }}
            export DB_CONTAINER_NAME=${{ env.DB_CONTAINER_NAME }}
            export REDIS_CONTAINER_NAME=${{ env.REDIS_CONTAINER_NAME }}
            export NGINX_CONTAINER_NAME=${{ env.NGINX_CONTAINER_NAME }}
            export DB_VOLUME_NAME=${{ env.DB_VOLUME_NAME }}
            export REDIS_VOLUME_NAME=${{ env.REDIS_VOLUME_NAME }}
            export NGINX_PORT=${{ env.NGINX_PORT }}
            export APP_PORT=${{ env.APP_PORT }}

            echo "üöÄ Starting deployment..."

            echo "üßπ Stopping old containers..."
            docker compose down --remove-orphans || true

            echo "üî® Building & starting containers..."
            docker compose up -d --build --remove-orphans

            echo "‚è≥ Waiting for containers to start..."

            MAX_WAIT=300
            WAITED=0

            while [ $WAITED -lt $MAX_WAIT ]; do
              RUNNING=$(docker compose ps --services --filter "status=running" | wc -l)
              EXPECTED=$(docker compose config --services | wc -l)

              echo "  ${WAITED}s ‚Üí Running $RUNNING / $EXPECTED"

              if [ "$RUNNING" -ge "$EXPECTED" ]; then
                echo "‚úÖ All services are running"
                break
              fi

              sleep 5
              WAITED=$((WAITED + 5))
            done

            if [ $WAITED -ge $MAX_WAIT ]; then
              echo "‚ùå Services failed to start"
              docker compose ps
              docker compose logs --tail=100
              exit 1
            fi

            echo "‚úÖ Deployment completed"

  # ============================================================================
  # JOB 2 ‚Äî MIGRATIONS
  # ============================================================================
  migrate:
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Run database migrations
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: 22
          command_timeout: 10m
          script: |
            set -e

            cd /home/${{ secrets.USERNAME }}/${{ env.COMPOSE_PROJECT_NAME }}

            export COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }}

            set -a
            source .env
            set +a

            echo "‚è≥ Waiting for DB..."

            MAX_WAIT=60
            WAITED=0

            while [ $WAITED -lt $MAX_WAIT ]; do
              if docker compose exec -T db pg_isready -U "$POSTGRES_USER"; then
                echo "‚úÖ Database ready"
                break
              fi
              sleep 2
              WAITED=$((WAITED + 2))
            done

            if [ $WAITED -ge $MAX_WAIT ]; then
              echo "‚ùå Database not ready"
              exit 1
            fi

            echo "üìù Running migrations..."
            docker compose --profile migrate run --rm migrate

            echo "‚úÖ Migrations completed"

  # ============================================================================
  # JOB 3 ‚Äî VERIFY
  # ============================================================================
  verify:
    runs-on: ubuntu-latest
    needs: migrate

    steps:
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: 22
          command_timeout: 5m
          script: |
            set -e

            cd /home/${{ secrets.USERNAME }}/${{ env.COMPOSE_PROJECT_NAME }}

            export COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }}

            set -a
            source .env
            set +a

            echo "üìä Container status:"
            docker compose ps

            echo "üè• Health check..."
            sleep 5

            if curl -sf http://localhost:${{ env.NGINX_PORT }}/health; then
              echo "‚úÖ Health OK (nginx)"
              exit 0
            fi

            if docker compose exec -T app wget -qO- http://localhost:3000/health; then
              echo "‚úÖ Health OK (app)"
              exit 0
            fi

            echo "‚ùå Health check failed"
            docker compose logs --tail=100
            exit 1
