name: Deploy Production

on:
  push:
    branches: ['main']

concurrency:
  group: deploy-production
  cancel-in-progress: true

env:
  COMPOSE_PROJECT_NAME: 10xcoder-prod
  APP_CONTAINER_NAME: 10xcoder_app
  DB_CONTAINER_NAME: 10xcoder_db
  REDIS_CONTAINER_NAME: 10xcoder_redis
  NGINX_CONTAINER_NAME: 10xcoder_nginx
  NGINX_PORT: 80
  APP_PORT: 3000

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ----------------------------------------------------------------------
      # Checkout
      # ----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------------------------------------------------
      # Create ENV file
      # ----------------------------------------------------------------------
      - name: Create production env file
        run: |
          echo "${{ secrets.ENV_FILE_PROD }}" > .env.production

      # ----------------------------------------------------------------------
      # Copy project to EC2
      # ----------------------------------------------------------------------
      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: 22
          source: >
            docker-compose.yml,
            nginx,
            apps/api,
            apps/web/package.json,
            packages,
            package.json,
            bun.lock,
            tsconfig.base.json,
            .env.production,
            scripts
          target: /home/${{ secrets.USERNAME }}/10xcoder-prod

      # ----------------------------------------------------------------------
      # Deploy on EC2
      # ----------------------------------------------------------------------
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: 22
          command_timeout: 20m
          script: |
            set -e

            cd /home/${{ secrets.USERNAME }}/10xcoder-prod

            echo "ðŸ” Loading environment"
            mv .env.production .env || true
            set -a
            source .env
            set +a

            export COMPOSE_PROJECT_NAME=10xcoder-prod

            echo "ðŸ§¹ Freeing port 80"
            sudo systemctl stop nginx || true
            sudo systemctl stop apache2 || true
            sudo fuser -k 80/tcp || true

            echo "ðŸ§¹ Stopping old containers"
            docker compose down --remove-orphans || true

            echo "ðŸ—‘ï¸ Cleaning dangling images"
            docker image prune -f || true

            echo "ðŸš€ Building & starting containers"
            docker compose up -d --build

            echo "â³ Waiting for DB to be ready"
            for i in {1..30}; do
              if docker compose exec -T db pg_isready -U "$POSTGRES_USER" >/dev/null 2>&1; then
                echo "âœ… DB ready"
                break
              fi
              sleep 2
            done

            echo "ðŸ§ª Running migrations"
            docker compose --profile migrate run --rm migrate || true

            echo "â³ Waiting for app container"
            for i in {1..30}; do
              STATUS=$(docker inspect -f '{{.State.Status}}' 10xcoder_app 2>/dev/null || true)
              if [ "$STATUS" = "running" ]; then
                echo "âœ… App is running"
                break
              fi
              sleep 2
            done

            echo "ðŸ“Š Final container status"
            docker compose ps

            echo "ðŸŽ‰ Deployment completed successfully"
