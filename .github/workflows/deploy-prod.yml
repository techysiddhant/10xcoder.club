name: Deploy Production

on:
  push:
    branches: ['main']

concurrency:
  group: deploy-production
  cancel-in-progress: true

env:
  COMPOSE_PROJECT_NAME: 10xcoder-prod
  APP_CONTAINER_NAME: 10xcoder_app

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Write env file
        run: echo "${{ secrets.ENV_FILE_PROD }}" > .env

      - name: Upload files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          source: docker-compose.yml,apps,packages,nginx,.env,package.json,bun.lock,tsconfig.base.json
          target: /home/${{ secrets.USERNAME }}/10xcoder-prod

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          command_timeout: 15m
          script: |
            set -e

            cd ~/10xcoder-prod

            echo "üßπ Freeing port 80 (host-level)"
            sudo systemctl stop nginx || true
            sudo systemctl stop apache2 || true
            sudo fuser -k 80/tcp || true

            echo "üßπ Stopping old containers"
            docker compose down || true

            echo "üöÄ Starting stack"
            docker compose up -d --build || true

            echo "üß™ Running migrations"
            docker compose --profile migrate run --rm migrate || true

            echo "‚è≥ Waiting for app to be running"
            for i in {1..30}; do
              if docker inspect -f '{{.State.Status}}' $APP_CONTAINER_NAME | grep -q running; then
                echo "‚úÖ App is running"
                break
              fi
              sleep 2
            done

            echo "üîç Final verification"
            docker inspect -f '{{.State.Status}}' $APP_CONTAINER_NAME | grep running

            echo "üéâ Deployment successful"
